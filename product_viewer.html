<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProductMaster System Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
                    <div class="container-fluid">
                        <span class="navbar-brand">
                            <i class="fas fa-box"></i> ProductMaster System
                        </span>
                        <span class="navbar-text">
                            商品情報管理システム
                        </span>
                    </div>
                </nav>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-search"></i> 商品検索</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="searchQuery" placeholder="商品名で検索...">
                        </div>
                        <div class="mb-3">
                            <select class="form-select" id="productType">
                                <option value="">全ての商品タイプ</option>
                                <option value="bond">債券</option>
                                <option value="stock">株式</option>
                                <option value="fund">投資信託</option>
                                <option value="structured_product">仕組み商品</option>
                            </select>
                        </div>
                        <button class="btn btn-primary w-100" onclick="searchProducts()">
                            <i class="fas fa-search"></i> 検索
                        </button>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-tags"></i> カテゴリ</h5>
                    </div>
                    <div class="card-body" id="categories">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-list"></i> 商品一覧</h5>
                        <span class="badge bg-secondary" id="productCount">0件</span>
                    </div>
                    <div class="card-body">
                        <div id="productList">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001';
        const API_TOKEN = 'demo-token-12345';

        const headers = {
            'Authorization': `Bearer ${API_TOKEN}`,
            'Content-Type': 'application/json'
        };

        async function loadProducts() {
            try {
                const response = await fetch(`${API_BASE}/api/products/`, { headers });
                const products = await response.json();
                displayProducts(products);
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('productList').innerHTML = 
                    '<div class="alert alert-danger">商品データの読み込みに失敗しました</div>';
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE}/api/categories/`, { headers });
                const categories = await response.json();
                displayCategories(categories);
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function displayProducts(products) {
            const productList = document.getElementById('productList');
            const productCount = document.getElementById('productCount');
            
            productCount.textContent = `${products.length}件`;

            if (products.length === 0) {
                productList.innerHTML = '<div class="alert alert-info">商品が見つかりませんでした</div>';
                return;
            }

            const html = products.map(product => `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="card-title">
                                    ${product.product_name}
                                    <span class="badge bg-${getTypeColor(product.product_type)} ms-2">
                                        ${getTypeLabel(product.product_type)}
                                    </span>
                                </h6>
                                <p class="card-text text-muted">${product.description || ''}</p>
                                <div class="row">
                                    <div class="col-sm-6">
                                        <small class="text-muted">発行者:</small> ${product.issuer || '-'}<br>
                                        <small class="text-muted">通貨:</small> ${product.currency}
                                    </div>
                                    <div class="col-sm-6">
                                        <small class="text-muted">リスクレベル:</small> ${product.risk_level || '-'}<br>
                                        <small class="text-muted">最小投資額:</small> ¥${product.minimum_investment?.toLocaleString() || '-'}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                ${product.maturity_date ? `
                                    <div class="mb-2">
                                        <small class="text-muted">満期日:</small><br>
                                        <strong>${product.maturity_date}</strong>
                                    </div>
                                ` : ''}
                                ${product.interest_rate ? `
                                    <div class="mb-2">
                                        <small class="text-muted">利率:</small><br>
                                        <strong>${(parseFloat(product.interest_rate) * 100).toFixed(2)}%</strong>
                                    </div>
                                ` : ''}
                                <button class="btn btn-sm btn-outline-primary" onclick="viewProduct(${product.product_id})">
                                    <i class="fas fa-eye"></i> 詳細
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            productList.innerHTML = html;
        }

        function displayCategories(categories) {
            const categoriesDiv = document.getElementById('categories');
            const mainCategories = categories.filter(cat => !cat.parent_category_id);
            
            const html = mainCategories.map(cat => `
                <div class="mb-2">
                    <button class="btn btn-outline-secondary btn-sm w-100" 
                            onclick="filterByCategory('${cat.category_code}')">
                        ${cat.category_name}
                    </button>
                </div>
            `).join('');

            categoriesDiv.innerHTML = html;
        }

        async function searchProducts() {
            const query = document.getElementById('searchQuery').value;
            const productType = document.getElementById('productType').value;
            
            try {
                let url = `${API_BASE}/api/products/search?`;
                if (query) url += `q=${encodeURIComponent(query)}&`;
                if (productType) url += `product_type=${productType}&`;
                
                const response = await fetch(url, { headers });
                const data = await response.json();
                displayProducts(data.products || []);
            } catch (error) {
                console.error('Error searching products:', error);
            }
        }

        async function viewProduct(productId) {
            try {
                const response = await fetch(`${API_BASE}/api/products/${productId}`, { headers });
                const product = await response.json();
                
                alert(`商品詳細:\\n\\n商品名: ${product.product_name}\\n商品コード: ${product.product_code}\\n発行者: ${product.issuer}\\n説明: ${product.description}`);
            } catch (error) {
                console.error('Error viewing product:', error);
            }
        }

        function getTypeColor(type) {
            const colors = {
                'bond': 'primary',
                'stock': 'danger', 
                'fund': 'success',
                'structured_product': 'warning',
                'insurance': 'info'
            };
            return colors[type] || 'secondary';
        }

        function getTypeLabel(type) {
            const labels = {
                'bond': '債券',
                'stock': '株式',
                'fund': '投信',
                'structured_product': '仕組み債',
                'insurance': '保険'
            };
            return labels[type] || type;
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            loadCategories();
        });

        // Enterキーで検索
        document.getElementById('searchQuery').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchProducts();
            }
        });
    </script>
</body>
</html>
